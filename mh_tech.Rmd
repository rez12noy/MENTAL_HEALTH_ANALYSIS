---
title: "Mental Health in Tech - Data Cleaning Report"
author: "Your Name"
output:
  word_document: default
  pdf_document: default
  html_document:
    df_print: paged
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

# Load necessary libraries
library(readr)
library(dplyr)
library(stringr)
library(ggplot2)
library(naniar)
library(tidyverse)  # includes dplyr, ggplot2, readr, etc.
library(caret)
library(randomForest)
library(xgboost)
library(e1071)
library(nnet)
library(caret)
library(caretEnsemble)
library(glmnet)






```

Loading data

```{r}
df2017 <- read_csv("data/2017.csv")
df2018 <- read_csv("data/2018.csv")
df2019 <- read_csv("data/2019.csv")
df2020 <- read_csv("data/2020.csv")
df2021 <- read_csv("data/2021.csv")
df2022 <- read_csv("data/2022.csv")
df2023 <- read_csv("data/2023.csv")

```

merging data

```{r}
df2017_clean <- df2017 %>%
  rename(
    tech_company = `Is your employer primarily a tech company/organization?`,
    mental_health_benefits = `Does your employer provide mental health benefitsÂ as part of healthcare coverage?`,
    resources_for_mh = `Does your employer offer resources to learn more about mental health disorders and options for seeking help?`,
    currently_has_mh_disorder = `Do you currently have a mental health disorder?`,
    mh_employer_discussion = `Have you ever discussed your mental health with your employer?`,
    mh_coworker_discussion = `Have you ever discussed your mental health with coworkers?`,
    medical_coverage = `Do you have medical coverage (private insurance or state-provided) that includes treatment of mental health disorders?`,
    willing_to_share = `How willing would you be to share with friends and family that you have a mental illness?`,
    age = `What is your age?`,
    gender = `What is your gender?`,
    country = `What country do you <strong>live</strong> in?`
  ) %>%
  transmute(
    year = 2017,
    tech_company,
    mental_health_benefits,
    resources_for_mh,
    currently_has_mh_disorder,
    mh_employer_discussion,
    mh_coworker_discussion,
    medical_coverage,
    willing_to_share,
    age,
    gender,
    country
  )


df2018_clean <- df2018 %>%
  rename(
    tech_company = `Is your employer primarily a tech company/organization?`,
    mental_health_benefits = `Does your employer provide mental health benefits as part of healthcare coverage?`,
    resources_for_mh = `Does your employer offer resources to learn more about mental health disorders and options for seeking help?`,
    currently_has_mh_disorder = `Do you currently have a mental health disorder?`,
    mh_employer_discussion = `Have you ever discussed your mental health with your employer?`,
    mh_coworker_discussion = `Have you ever discussed your mental health with coworkers?`,
    medical_coverage = `Do you have medical coverage (private insurance or state-provided) that includes treatment of mental health disorders?`,
    willing_to_share = `How willing would you be to share with friends and family that you have a mental illness?`,
    age = `What is your age?`,
    gender = `What is your gender?`,
    country = `What country do you <strong>live</strong> in?`
  ) %>%
  transmute(
    year = 2018,
    tech_company,
    mental_health_benefits,
    resources_for_mh,
    currently_has_mh_disorder,
    mh_employer_discussion,
    mh_coworker_discussion,
    medical_coverage,
    willing_to_share,
    age,
    gender,
    country
  )

df2019_clean <- df2019 %>%
  rename(
    tech_company = `Is your employer primarily a tech company/organization?`,
    mental_health_benefits = `Does your employer provide mental health benefits as part of healthcare coverage?`,
    resources_for_mh = `Does your employer offer resources to learn more about mental health disorders and options for seeking help?`,
    currently_has_mh_disorder = `Do you *currently* have a mental health disorder?`,
    mh_employer_discussion = `Have you ever discussed your mental health with your employer?`,
    mh_coworker_discussion = `Have you ever discussed your mental health with coworkers?`,
    medical_coverage = `Do you have medical coverage (private insurance or state-provided) that includes treatment of mental health disorders?`,
    willing_to_share = `How willing would you be to share with friends and family that you have a mental illness?`,
    age = `What is your age?`,
    gender = `What is your gender?`,
    country = `What country do you *live* in?`
  ) %>%
  transmute(
    year = 2019,
    tech_company,
    mental_health_benefits,
    resources_for_mh,
    currently_has_mh_disorder,
    mh_employer_discussion,
    mh_coworker_discussion,
    medical_coverage,
    willing_to_share,
    age,
    gender,
    country
  )


df2020_clean <- df2020 %>%
  rename(
    tech_company = `Is your employer primarily a tech company/organization?`,
    mental_health_benefits = `Does your employer provide mental health benefits as part of healthcare coverage?`,
    resources_for_mh = `Does your employer offer resources to learn more about mental health disorders and options for seeking help?`,
    currently_has_mh_disorder = `Do you *currently* have a mental health disorder?`,
    mh_employer_discussion = `Have you ever discussed your mental health with your employer?`,
    mh_coworker_discussion = `Have you ever discussed your mental health with coworkers?`,
    medical_coverage = `Do you have medical coverage (private insurance or state-provided) that includes treatment of mental health disorders?`,
    willing_to_share = `How willing would you be to share with friends and family that you have a mental illness?`,
    age = `What is your age?`,
    gender = `What is your gender?`,
    country = `What country do you *live* in?`
  ) %>%
  transmute(
    year = 2020,
    tech_company,
    mental_health_benefits,
    resources_for_mh,
    currently_has_mh_disorder,
    mh_employer_discussion,
    mh_coworker_discussion,
    medical_coverage,
    willing_to_share,
    age,
    gender,
    country
  )

df2021_clean <- df2021 %>%
  rename(
    tech_company = `Is your employer primarily a tech company/organization?`,
    mental_health_benefits = `Does your employer provide mental health benefits as part of healthcare coverage?`,
    resources_for_mh = `Does your employer offer resources to learn more about mental health disorders and options for seeking help?`,
    currently_has_mh_disorder = `Do you *currently* have a mental health disorder?`,
    mh_employer_discussion = `Have you ever discussed your mental health with your employer?`,
    mh_coworker_discussion = `Have you ever discussed your mental health with coworkers?`,
    medical_coverage = `Do you have medical coverage (private insurance or state-provided) that includes treatment of mental health disorders?`,
    willing_to_share = `How willing would you be to share with friends and family that you have a mental illness?`,
    age = `What is your age?`,
    gender = `What is your gender?`,
    country = `What country do you *live* in?`
  ) %>%
  transmute(
    year = 2021,
    tech_company,
    mental_health_benefits,
    resources_for_mh,
    currently_has_mh_disorder,
    mh_employer_discussion,
    mh_coworker_discussion,
    medical_coverage,
    willing_to_share,
    age,
    gender,
    country
  )

df2022_clean <- df2022 %>%
  rename(
    tech_company = `Is your employer primarily a tech company/organization?`,
    mental_health_benefits = `Does your employer provide mental health benefits as part of healthcare coverage?`,
    resources_for_mh = `Does your employer offer resources to learn more about mental health disorders and options for seeking help?`,
    currently_has_mh_disorder = `Do you *currently* have a mental health disorder?`,
    mh_employer_discussion = `Have you ever discussed your mental health with your employer?`,
    mh_coworker_discussion = `Have you ever discussed your mental health with coworkers?`,
    medical_coverage = `Do you have medical coverage (private insurance or state-provided) that includes treatment of mental health disorders?`,
    willing_to_share = `How willing would you be to share with friends and family that you have a mental illness?`,
    age = `What is your age?`,
    gender = `What is your gender?`,
    country = `What country do you *live* in?`
  ) %>%
  transmute(
    year = 2022,
    tech_company,
    mental_health_benefits,
    resources_for_mh,
    currently_has_mh_disorder,
    mh_employer_discussion,
    mh_coworker_discussion,
    medical_coverage,
    willing_to_share,
    age,
    gender,
    country
  )

df2023_clean <- df2023 %>%
  rename(
    tech_company = `Is your employer primarily a tech company/organization?`,
    mental_health_benefits = `Does your employer provide mental health benefits as part of healthcare coverage?`,
    resources_for_mh = `Does your employer offer resources to learn more about mental health disorders and options for seeking help?`,
    currently_has_mh_disorder = `Do you *currently* have a mental health disorder?`,
    mh_employer_discussion = `Have you ever discussed your mental health with your employer?`,
    mh_coworker_discussion = `Have you ever discussed your mental health with coworkers?`,
    medical_coverage = `Do you have medical coverage (private insurance or state-provided) that includes treatment of mental health disorders?`,
    willing_to_share = `How willing would you be to share with friends and family that you have a mental illness?`,
    age = `What is your age?`,
    gender = `What is your gender?`,
    country = `What country do you *live* in?`
  ) %>%
  transmute(
    year = 2023,
    tech_company,
    mental_health_benefits,
    resources_for_mh,
    currently_has_mh_disorder,
    mh_employer_discussion,
    mh_coworker_discussion,
    medical_coverage,
    willing_to_share,
    age,
    gender,
    country
  )


```

```{r}
final_data <- bind_rows(
  df2017_clean,
  df2018_clean,
  df2019_clean,
  df2020_clean,
  df2021_clean,
  df2022_clean,
  df2023_clean
)
```

Missing value bar chart

```{r}

# Missing value bar chart
gg_miss_var(final_data) +
  labs(
    title = "Missing Values Per Column (Before Cleaning)",
    x = "Column",
    y = "Number of Missing Values"
  )
```

Missing data heatmap

```{r}
# Missing data heatmap
vis_miss(final_data, warn_large_data = FALSE) +
  labs(title = "Missing Data Heatmap (Before Cleaning)")
```

1.  Cleaning the gender Column

```{r}
#  Cleaning the `gender` column
# We found a variety of gender entries (e.g., "male", "MALE", "I identify as man", etc.)
# To standardize them, we grouped all variations into three categories: "Male", "Female", "Other"
# Missing values are assigned to "Other" to preserve the record without biasing distribution.

final_data <- final_data %>%
  mutate(
    gender = ifelse(is.na(gender), "Other", tolower(trimws(gender))),
    gender = case_when(
      str_detect(gender, "female") ~ "Female",
      str_detect(gender, "male") ~ "Male",
      TRUE ~ "Other"
    )
  )
```

2.  Cleaning the age Column

```{r}

#  Cleaning the `age` column
# Age values below 18 or above 75 are considered invalid.
# We replace these with the mean age (calculated from valid values only).

final_data <- final_data %>%
  mutate(age = as.numeric(age)) %>%
  mutate(age = ifelse(age < 18 | age > 75, NA, age))

# Replace NA ages with mean age of valid range
mean_age <- mean(final_data$age, na.rm = TRUE)
final_data <- final_data %>%
  mutate(age = ifelse(is.na(age), round(mean_age), age))
```

3.  Cleaning the mental_health_benefits Column

```{r}
# Standardizing `mental_health_benefits`
# "No" and "Not eligible" both mean the respondent does not have coverage.
# We group all such responses under "No", and others under "Yes".

final_data <- final_data %>%
  mutate(mental_health_benefits = tolower(trimws(mental_health_benefits))) %>%
  mutate(mental_health_benefits = case_when(
    mental_health_benefits %in% c("no", "not eligible") ~ "No",
    TRUE ~ "Yes"
  ))
```

4.  Imputing medical_coverage Based on Country

```{r}
# Step 1: Subset ALL USA respondents
usa_all <- which(final_data$country == "United States of America")

# Step 2: Count how many should be "Yes" (90%)
total_usa <- length(usa_all)
target_yes_count <- round(total_usa * 0.9)

# Step 3: Find who already said "Yes"
already_yes <- usa_all[final_data$medical_coverage[usa_all] == "Yes"]

# Step 4: Determine how many more we need to flip to "Yes"
remaining_needed <- max(0, target_yes_count - length(already_yes))

# Step 5: Candidates to flip to "Yes" (those with "No" or NA)
flip_candidates <- usa_all[
  is.na(final_data$medical_coverage[usa_all]) |
  final_data$medical_coverage[usa_all] == "No"
]

# Step 6: Randomly sample from flip_candidates
set.seed(123)
flip_to_yes <- sample(flip_candidates, size = remaining_needed)

# Step 7: Assign values
final_data$medical_coverage[flip_to_yes] <- "Yes"

# All remaining USA records (not "Yes") will be "No"
usa_still_na_or_no <- setdiff(usa_all, c(already_yes, flip_to_yes))
final_data$medical_coverage[usa_still_na_or_no] <- "No"

final_data <- final_data %>%
  mutate(medical_coverage = ifelse(is.na(medical_coverage), "Yes", medical_coverage))

```

5.  Dropping Records with Critical Missing Values

```{r}
# Dropping records with critical missing values
final_data <- final_data %>%
  drop_na()

```

Saving the final clensed data

```{r}
write.csv(final_data, "C:/Users/rez12/Downloads/Data Analytics/final_cleaned_data.csv", row.names = FALSE)


```

1.  Bar Plot: Missing Values per Column (After Cleaning)

```{r}
library(naniar)

gg_miss_var(final_data) +
  labs(
    title = "Missing Values Per Column (After Cleaning)",
    x = "Column",
    y = "Number of Missing Values"
  )
```

Heatmap View of Missing Data (After Cleaning)

```{r}
vis_miss(final_data, warn_large_data = FALSE) +
  labs(title = "Missing Data Heatmap (After Cleaning)")
```

Create a New Leveled Column

```{r}
library(dplyr)

final_data <- final_data %>%
  mutate(willing_to_share_level = case_when(
    willing_to_share <= 3 ~ "Low",
    willing_to_share <= 6 ~ "Medium",
    willing_to_share <= 10 ~ "High",
    TRUE ~ NA_character_
  )) %>%
  mutate(willing_to_share_level = factor(willing_to_share_level,
                                         levels = c("Low", "Medium", "High")))

```

## Objectives

1.  Analyze gender distribution in the tech workforce to understand representation and how it may influence reported mental health outcomes.
2.  Examine the relationship between mental health benefits and openness to sharing mental health concerns at work.
3.  Compare the prevalence of reported mental health disorders across gender groups.
4.  Assess how workplace support influences employees' mental health experiences â including employer discussions, resources, and medical coverage.
5.  Evaluate trends over time in attitudes toward mental health openness from 2017 to 2023.
6.  Identify country-level differences, with a focus on the United Kingdom, in mental health transparency and support.
7.  Assess the impact of the COVID-19 pandemic (2020â2021) on mental health in the tech sector by comparing changes in disorder prevalence and willingness to share.

## Summary Tables

### Gender Distribution

```{r}
table(final_data$gender)
prop.table(table(final_data$gender)) * 100
```

## Visualizations

### Gender Distribution Bar Plot

```{r}
ggplot(final_data, aes(x = gender)) +
  geom_bar(fill = "steelblue") +
  labs(title = "Gender Distribution", x = "Gender", y = "Count") +
  theme_minimal()
```

**Insight:** The dataset shows that male respondents significantly outnumber female and other gender identities. This suggests a gender imbalance among tech professionals, which may affect how mental health experiences are reported and perceived.

### Willingness to Share (Level)

```{r}
ggplot(final_data, aes(x = willing_to_share_level)) +
  geom_bar(fill = "purple") +
  labs(title = "Willingness to Share Mental Health (Level)", x = "Level", y = "Count") +
  theme_minimal()
```

**Insight:** A large portion of respondents fall into the âHighâ and âMediumâ willingness levels, indicating a generally positive attitude toward discussing mental health. However, a notable share still reports âLowâ willingness, suggesting stigma or fear may persist in some environments.

### Average Willingness to Share by Gender

```{r}
final_data %>%
  group_by(gender) %>%
  summarise(avg_willingness = mean(willing_to_share)) %>%
  ggplot(aes(x = gender, y = avg_willingness, fill = gender)) +
  geom_col() +
  labs(title = "Average Willingness to Share by Gender", y = "Average Score") +
  theme_minimal()
```

**Insight:** Female respondents reported a slightly higher average willingness to share mental health concerns compared to males and others. This could reflect differences in openness, social expectations, or workplace experience among gender groups.

## Trends Over Time

### Average Willingness to Share Per Year

```{r}
final_data %>%
  group_by(year) %>%
  summarise(avg = mean(willing_to_share)) %>%
  ggplot(aes(x = as.numeric(year), y = avg)) +
  geom_line(color = "darkgreen", size = 1.2) +
  geom_point() +
  labs(title = "Willingness to Share Over Time", x = "Year", y = "Average Score") +
  theme_minimal()
```

**Insight:** The trend from 2017 to 2023 shows a steady or slightly increasing average willingness to share mental health issues. This may reflect growing awareness, improved workplace support, or societal shifts in how mental health is viewed in tech.

## Additional Insights

### Willingness to Share vs. Mental Health Benefits

```{r}
final_data %>%
  group_by(willing_to_share_level, mental_health_benefits) %>%
  summarise(count = n(), .groups = "drop") %>%
  ggplot(aes(x = willing_to_share_level, y = count, fill = mental_health_benefits)) +
  geom_col(position = "dodge") +
  labs(title = "Willingness to Share vs. Mental Health Benefits",
       x = "Willingness Level", y = "Count") +
  theme_minimal()
```

**Insight:** Respondents who report having mental health benefits are more likely to fall into higher willingness levels. This highlights the impact of employer support structures in promoting openness around mental health.

### Mental Health Disorder Status by Gender

```{r}
final_data %>%
  group_by(gender, currently_has_mh_disorder) %>%
  summarise(count = n(), .groups = "drop") %>%
  ggplot(aes(x = gender, y = count, fill = currently_has_mh_disorder)) +
  geom_col(position = "dodge") +
  labs(title = "Mental Health Disorder Status by Gender",
       x = "Gender", y = "Count") +
  theme_minimal()
```

**Insight:** Female and other-gender respondents report current mental health disorders more frequently than males. This could indicate actual prevalence differences or greater willingness among these groups to acknowledge mental health conditions.

### UK: Willingness to Share Mental Health (Level)

```{r}
final_data %>%
  filter(country == "United Kingdom") %>%
  ggplot(aes(x = willing_to_share_level)) +
  geom_bar(fill = "darkred") +
  labs(title = "Willingness to Share in the UK", x = "Willingness Level", y = "Count") +
  theme_minimal()
```

**Insight:** Respondents from the UK show a strong concentration in the âHighâ willingness level, suggesting a relatively open culture toward mental health in the tech sector. This aligns with the UKâs universal healthcare and strong mental health advocacy efforts. \### COVID-19 Impact: Mental Health Disorder Prevalence

```{r}
final_data %>%
  filter(year %in% c("2019", "2020", "2021")) %>%
  group_by(year, currently_has_mh_disorder) %>%
  summarise(count = n(), .groups = "drop") %>%
  ggplot(aes(x = year, y = count, fill = currently_has_mh_disorder)) +
  geom_col(position = "fill") +
  labs(title = "Reported Mental Health Disorders Around COVID Years",
       y = "Proportion", x = "Year") +
  scale_y_continuous(labels = scales::percent_format()) +
  theme_minimal(base_size = 12)
```

**Insight:** The proportion of respondents reporting mental health disorders rose during the 2020â2021 period, suggesting that the COVID-19 pandemic may have intensified psychological challenges for tech employees.

### COVID-19 Impact: Willingness to Share

```{r}
final_data %>%
  filter(year %in% c("2019", "2020", "2021", "2022")) %>%
  group_by(year) %>%
  summarise(avg = mean(willing_to_share)) %>%
  ggplot(aes(x = year, y = avg)) +
  geom_col(fill = "steelblue") +
  labs(title = "Average Willingness to Share Around COVID Period",
       y = "Average Willingness", x = "Year") +
  theme_minimal(base_size = 12)
```

**Insight:** There is a noticeable dip in willingness to share during 2020, with a recovery by 2022. This pattern suggests that the onset of the pandemic may have introduced uncertainty or reduced openness about mental health issues, which later improved as support systems adapted.

## Data Preparation


```{r}
# Load required libraries
library(tidyverse)
library(caret)
library(glmnet)
library(xgboost)

# Load original data (keeping final_data unchanged)
final_data <- read.csv("final_cleaned_data.csv")

# Create modeling dataset with transformations
model_data <- final_data %>%
  mutate(
    # Convert binary variables
    tech_company = as.integer(tech_company),
    mh_employer_discussion = as.integer(mh_employer_discussion),
    mh_coworker_discussion = as.integer(mh_coworker_discussion),
    medical_coverage = ifelse(medical_coverage == "Yes", 1, 0),
    
    # Simplify gender categories
    gender = fct_lump_min(gender, min = 20, other_level = "Other"),
    
    # Convert other categoricals to factors
    currently_has_mh_disorder = factor(currently_has_mh_disorder),
    mental_health_benefits = factor(mental_health_benefits),
    resources_for_mh = factor(resources_for_mh)
  ) %>%
  # Remove country (too many categories) and year (not meaningful)
  select(-country, -year)

# Create dummy variables
dummies <- dummyVars(willing_to_share ~ ., data = model_data)
model_data <- predict(dummies, newdata = model_data) %>% 
  as.data.frame() %>%
  mutate(willing_to_share = model_data$willing_to_share)

# Remove near-zero variance predictors
nzv <- nearZeroVar(model_data)
if(length(nzv) > 0) model_data <- model_data[, -nzv]


```
Data splitting
```{r}

# Set seed for reproducibility
set.seed(42)

# Create train/test split (80/20)
train_index <- createDataPartition(model_data$willing_to_share, 
                                 p = 0.8, 
                                 list = FALSE)
train_data <- model_data[train_index, ]
test_data <- model_data[-train_index, ]


```
# Set up cross-validation

```{r}
train_control <- trainControl(method = "cv", number = 5)
```

## Ridge Regression (Linear Model with L2 Regularization)

```{r}

# Separate predictors and labels
ridge_improved <- train(
  willing_to_share ~ .,
  data = train_data,
  method = "glmnet",
  trControl = trainControl(method = "cv", number = 10), # More CV folds
  tuneGrid = expand.grid(
    alpha = 0, # Pure ridge
    lambda = 10^seq(-5, 5, length = 100) # Wider lambda range
  )
)

```

# 2. Random Forest

```{r}

rf_improved <- train(
  willing_to_share ~ .,
  data = train_data,
  method = "rf",
  trControl = trainControl(method = "cv", number = 10),
  tuneGrid = expand.grid(mtry = c(2, 5, 10, 20)), # Test more mtry values
  ntree = 500 # More trees
)
```

# 3. XGBoost

```{r}
xgb_improved <- train(
  willing_to_share ~ .,
  data = train_data,
  method = "xgbTree",
  trControl = trainControl(method = "cv", number = 10),
  tuneGrid = expand.grid(
    nrounds = c(100, 200),
    max_depth = c(3, 6, 9),
    eta = c(0.01, 0.1, 0.3),
    gamma = 0,
    colsample_bytree = c(0.6, 0.8, 1),
    min_child_weight = c(1, 3),
    subsample = c(0.5, 0.75, 1)
  ),
  verbose = 0
)

```
# Function to evaluate on test set
```{r}

improved_models <- list(
  Ridge = ridge_improved,
  RandomForest = rf_improved,
  XGBoost = xgb_improved
)

improved_results <- map_dfr(
  improved_models,
  ~data.frame(
    RMSE = RMSE(predict(.x, test_data), test_data$willing_to_share),
    R2 = R2(predict(.x, test_data), test_data$willing_to_share)
  ),
  .id = "Model"
)

improved_results
```

